#!/usr/bin/env bash
set -euo pipefail

cd /home/ec2-user/ev424_pages_site
TS="$(date "+%Y%m%dT%H%M%S%z")"
mkdir -p _bak

IDX="index.html"
P3="evidence-policy.html"

# hard guards (prevent empty vars)
[ -n "$IDX" ] && [ -n "$P3" ]
[ -f "$IDX" ] || { echo "FAIL: missing $IDX"; exit 20; }

echo "=== 0) PRE ==="
ls -l "$IDX"
sha256sum "$IDX"
grep -nE "Evidence Policy|REPRODUCIBLE ONLY" "$IDX" | head -n 80 || true
if grep -n "/${P3}" "$IDX" >/dev/null 2>&1; then
  echo "FAIL: link already exists: /$P3"
  exit 21
fi
echo "OK: no evidence-policy link yet"

echo
echo "=== 1) STAKE BACKUP (no overwrite) ==="
BIDX="_bak/${IDX}.stake.${TS}"
[ ! -e "$BIDX" ] || { echo "FAIL: exists $BIDX"; exit 22; }
cp -a "$IDX" "$BIDX"
echo "OK: $BIDX"
sha256sum "$BIDX"

if [ -e "$P3" ]; then
  BP3="_bak/${P3}.stake.${TS}"
  [ ! -e "$BP3" ] || { echo "FAIL: exists $BP3"; exit 23; }
  cp -a "$P3" "$BP3"
  echo "OK: $BP3"
  sha256sum "$BP3"
  echo "FAIL: $P3 already exists (overwrite forbidden). Stop."
  exit 24
fi

echo
echo "=== 2) PATCH index.html: wrap 3rd card (Evidence Policy) with <a> ==="
python3 - <<'"'"'PY'"'"'
import re, sys

path="index.html"
lines=open(path,"r",encoding="utf-8").read().splitlines(True)
full="".join(lines)

if "/evidence-policy.html" in full:
    print("FAIL: evidence-policy link already present")
    sys.exit(31)

# locate the Evidence Policy card via the k-line
k_idx=None
for i,ln in enumerate(lines):
    if 'class="k"' in ln and "Evidence Policy" in ln:
        k_idx=i
        break
if k_idx is None:
    print("FAIL: could not find Evidence Policy marker (class=k + text)")
    sys.exit(32)

# find nearest card start above
start=None
for i in range(k_idx, -1, -1):
    if "<div" in lines[i] and 'class="card' in lines[i]:
        start=i
        break
if start is None:
    print("FAIL: could not find card start above marker")
    sys.exit(33)

def opens(ln):  return len(re.findall(r"<div\\b", ln))
def closes(ln): return len(re.findall(r"</div>", ln))

depth=0
end=None
for i in range(start, len(lines)):
    depth += opens(lines[i]) - closes(lines[i])
    if depth==0:
        end=i
        break
if end is None:
    print("FAIL: could not find matching </div> for the card block")
    sys.exit(34)

block="".join(lines[start:end+1])
if "REPRODUCIBLE ONLY" not in block:
    print("FAIL: safety stop (block missing REPRODUCIBLE ONLY)")
    sys.exit(35)

# patch open/close
lines[start]=re.sub(r'<div\\s+class="card[^"]*"[^>]*>',
                    '<a class="card card--policy" href="/evidence-policy.html">',
                    lines[start], count=1)
lines[end]=re.sub(r"</div>", "</a>", lines[end], count=1)

open(path,"w",encoding="utf-8").write("".join(lines))
print(f"OK: patched card lines {start+1}..{end+1}")
PY

echo
echo "=== 3) CREATE evidence-policy.html (EN primary + KR as translation only) ==="
cat > "$P3" <<'"'"'HTML'"'"'
<!doctype html>
<html lang="en">
<head>
  <meta name="classification" content="read-only verification platform" />
  <meta name="noinput" content="true" />
  <meta name="nowallet" content="true" />
  <meta name="nodatacollection" content="true" />
  <meta name="nophishing" content="true" />

  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="color-scheme" content="dark" />
  <title>EV424 — Evidence Policy</title>
  <meta name="description" content="Reproducible-only evidence policy. Verification uses official sources with clear provenance." />

  <style>
    :root{
      --bg0:#070b0e; --bg1:#0b1116;
      --panel:#0f1720cc; --stroke:#22313f;
      --text:#e7edf6; --muted:#a6b3c3;
      --green:#36d37a; --blue:#57a6ff;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      color:var(--text);
      background:linear-gradient(180deg,var(--bg0),var(--bg1));
    }
    .bg{
      position:fixed; inset:0;
      background:
        radial-gradient(1200px 600px at 20% 0%, rgba(54,211,122,.12), transparent 60%),
        radial-gradient(900px 500px at 80% 20%, rgba(87,166,255,.10), transparent 55%),
        radial-gradient(900px 600px at 50% 100%, rgba(54,211,122,.08), transparent 60%);
      pointer-events:none;
      filter: blur(0.2px);
    }
    .wrap{ width:min(980px,92vw); margin:24px auto 40px; }
    .topbar{display:flex; align-items:center; justify-content:space-between; gap:14px; margin-bottom:18px;}
    .brand{display:flex; align-items:center; gap:10px; font-weight:800;}
    .dot{width:10px; height:10px; border-radius:999px; background:var(--green); box-shadow:0 0 18px rgba(54,211,122,.35);}
    .brandname{letter-spacing:.2px}

    .hero{
      padding:18px 18px 14px;
      border:1px solid var(--stroke);
      border-radius:18px;
      background:rgba(12,18,24,.55);
      backdrop-filter: blur(8px);
    }
    .hero h1{margin:8px 0 6px; font-size:clamp(26px,4.4vw,40px); line-height:1.08;}
    .sub{margin:0; color:var(--muted); max-width:78ch; line-height:1.55;}

    .tag{display:inline-flex; gap:8px; align-items:center; font-size:12px; font-weight:900; letter-spacing:.3px; color:rgba(231,237,246,.92);}
    .pill{font-size:11px; padding:6px 10px; border-radius:999px; border:1px solid rgba(87,166,255,.32); background:rgba(10,18,26,.55); color:var(--blue);}

    .panel{
      margin-top:14px;
      padding:16px 16px;
      border:1px solid var(--stroke);
      border-radius:18px;
      background:var(--panel);
      backdrop-filter: blur(8px);
    }
    .panel h2{margin:0 0 12px; font-size:16px; letter-spacing:.2px; color:#dfe7f2;}
    .grid{display:grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap:10px;}
    .card{border:1px solid rgba(255,255,255,.10); background:rgba(9,14,18,.55); border-radius:14px; padding:12px; box-shadow:0 6px 18px rgba(0,0,0,.22);}
    .k{font-size:12px; color:var(--muted); margin-bottom:6px;}
    .v{font-size:15px; font-weight:900;}
    .p{margin:10px 0 0; color:var(--muted); line-height:1.58; font-size:13px;}
    .bul{margin:0; padding-left:18px; color:var(--muted);}
    .bul li{margin:7px 0; line-height:1.50;}
    .hr{height:1px; background:rgba(255,255,255,.08); margin:12px 0;}

    details{border:1px solid rgba(255,255,255,.08); border-radius:14px; background:rgba(9,14,18,.35); padding:10px 12px;}
    summary{cursor:pointer; color:#cfe2ff; font-weight:800;}
    details p{margin:8px 0 0; color:var(--muted); line-height:1.55; font-size:13px;}

    .btnrow{display:flex; gap:10px; flex-wrap:wrap;}
    .btn{
      display:inline-flex; align-items:center; justify-content:center; gap:8px;
      padding:12px 16px; border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      text-decoration:none; color:var(--text); font-weight:900;
      background:rgba(10,16,22,.35);
      user-select:none;
    }
    .btn:hover{border-color:rgba(255,255,255,.14)}

    .motto{
      margin-top:18px;
      color:rgba(166,179,195,.55);
      font-size:11px;
      font-weight:500;
      letter-spacing:.3px;
      text-align:center;
      width:100%;
    }

    @media (max-width:820px){
      .wrap{width:min(980px,94vw)}
      .grid{grid-template-columns:1fr}
    }
  </style>
</head>

<body>
  <div class="bg"></div>

  <main class="wrap">
    <header class="topbar">
      <div class="brand"><span class="dot"></span><span class="brandname">EV424</span></div>
    </header>

    <section class="hero">
      <div class="btnrow">
        <a class="btn" href="javascript:history.back()"><span aria-hidden="true">←</span><span>Back</span></a>
      </div>

      <div class="tag"><span class="pill">REPRODUCIBLE ONLY</span><span>Evidence Policy</span></div>

      <h1>Evidence Policy</h1>
      <p class="sub">
        Verification uses only official sources with clear provenance.<br />
        If the official bytes change, the SHA-256 fingerprint changes — and the change is detected.
      </p>

      <details style="margin-top:12px;">
        <summary>Korean translation (KR)</summary>
        <p>
          검증은 출처가 명확한 공식 원문으로만 합니다.<br />
          공식 원문 바이트가 바뀌면 SHA-256 지문도 바뀌며, 그 변화가 탐지됩니다.
        </p>
      </details>
    </section>

    <section class="panel">
      <h2>Policy summary</h2>
      <ul class="bul">
        <li><b>Non-reproducible data is rejected.</b></li>
        <li><b>Verification uses only official sources with clear provenance.</b></li>
        <li><b>Only re-verifiable evidence is preserved.</b></li>
      </ul>

      <details style="margin-top:12px;">
        <summary>Korean translation (KR)</summary>
        <p>
          재현 불가능한 데이터는 제외됩니다.<br />
          검증은 출처가 명확한 공식 원문으로만 합니다.<br />
          재검증 가능한 증거만 보존됩니다.
        </p>
      </details>
    </section>

    <section class="panel">
      <h2>Key definitions</h2>
      <div class="grid">
        <div class="card">
          <div class="k">Official source</div>
          <div class="v">Publisher-controlled original</div>
          <p class="p">The original document published and controlled by the issuer (organization/company/project) on an official channel.</p>
          <details style="margin-top:10px;">
            <summary>KR</summary>
            <p>발행 주체가 직접 게시·관리하는 공식 채널의 원문.</p>
          </details>
        </div>

        <div class="card">
          <div class="k">REPRODUCIBLE ONLY</div>
          <div class="v">Same input → same output</div>
          <p class="p">Same official bytes + same rules must reproduce the same fingerprint and receipt.</p>
          <details style="margin-top:10px;">
            <summary>KR</summary>
            <p>같은 공식 원문 바이트와 같은 규칙이면, 지문/영수증이 항상 동일하게 재현되어야 합니다.</p>
          </details>
        </div>

        <div class="card">
          <div class="k">No PDF mirroring</div>
          <div class="v">Publish verification, not redistribution</div>
          <p class="p">EV424 publishes URL, SHA-256 fingerprint, re-verify method, and receipt — not the original PDF content.</p>
          <details style="margin-top:10px;">
            <summary>KR</summary>
            <p>원문은 공식 링크로 제공하고, EV424는 검증 정보(지문/방법/영수증)만 공개합니다.</p>
          </details>
        </div>

        <div class="card">
          <div class="k">How users verify</div>
          <div class="v">Exact-match lookup</div>
          <p class="p">Public search accepts only Evidence ID (EV424-ENTRY-0000xx) or a 64-hex PASS hash.</p>
          <details style="margin-top:10px;">
            <summary>KR</summary>
            <p>대중 검색 키는 ENTRY_ID 또는 64자리 PASS 해시만 허용합니다(정확일치).</p>
          </details>
        </div>
      </div>
    </section>

    <section class="panel">
      <h2>How reproducible verification closes</h2>
      <ul class="bul">
        <li>Confirm an official source URL with clear provenance</li>
        <li>Compute SHA-256 from the official bytes</li>
        <li>Re-download check: the SHA-256 must match</li>
        <li>Lock the record: same input must not drift</li>
        <li>Close as a re-verifiable receipt</li>
      </ul>

      <details style="margin-top:12px;">
        <summary>KR</summary>
        <p>
          공식 원문 확인 → SHA-256 지문 생성 → 재다운 동일성 확인 → 기록 고정 → 영수증으로 종결.
        </p>
      </details>

      <div class="hr"></div>

      <h2>Rejected examples</h2>
      <ul class="bul">
        <li>Anything that cannot be re-downloaded from an official source</li>
        <li>Reuploads/copies/screenshots that replace the official original</li>
        <li>Standalone claims without a verifiable official original</li>
      </ul>

      <details style="margin-top:12px;">
        <summary>KR</summary>
        <p>
          공식 출처로 재다운/재검증이 불가능한 자료, 원문 대신 떠도는 재업로드/복사본, 원문 없는 단독 주장 등은 제외됩니다.
        </p>
      </details>
    </section>

    <section class="panel">
      <h2>Next</h2>
      <div class="btnrow">
        <a class="btn" href="/sha256-fingerprint.html">Core Technology — SHA-256</a>
        <a class="btn" href="/public_data/index.html" target="_blank" rel="noopener">Open Main Site</a>
        <a class="btn" href="/public_docs/index_v2.html" target="_blank" rel="noopener">Public Docs (Viewer)</a>
      </div>
    </section>

    <div class="motto">Accuracy(4)=Truth(2)=Life(4)</div>
  </main>
</body>
</html>
HTML

echo
echo "=== 4) POST PROOF ==="
ls -l "$IDX" "$P3"
sha256sum "$IDX" "$P3"

echo "--- index link proof ---"
grep -n "/evidence-policy.html" "$IDX" | head -n 5 || { echo "FAIL: link not found in index"; exit 40; }

echo "--- new page markers ---"
grep -n "^<!doctype html>" "$P3" >/dev/null
grep -n "</html>" "$P3" >/dev/null
grep -n "Evidence Policy" "$P3" >/dev/null
grep -n "<h2>Next</h2>" "$P3" >/dev/null
grep -n "Accuracy(4)=Truth(2)=Life(4)" "$P3" >/dev/null
SH

chmod +x /tmp/ev424_build_p3.sh
bash /tmp/ev424_build_p3.sh
'
