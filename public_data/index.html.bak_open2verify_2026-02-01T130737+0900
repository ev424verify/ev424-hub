<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="color-scheme" content="dark" />
  <title>EV424 — Evidence Index</title>
  <meta name="description" content="Public evidence index (toc.json → monthly index → entries)." />
  <style>
    :root{
      --bg0:#070b0e; --bg1:#0b1116;
      --panel:rgba(15,23,32,.80);
      --stroke:#22313f;
      --text:#e7edf6;
      --muted:#a6b3c3;
      --blue:#57a6ff;
      --blue2:#2f86ff;
      --good:#36d37a;
      --bad:#ff5a5a;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      color:var(--text);
      background:linear-gradient(180deg,var(--bg0),var(--bg1));
    }
    .bg{
      position:fixed; inset:0;
      background:
        radial-gradient(1200px 600px at 20% 0%, rgba(87,166,255,.12), transparent 60%),
        radial-gradient(900px 600px at 70% 80%, rgba(54,211,122,.08), transparent 60%);
      pointer-events:none;
    }
    .wrap{width:min(1000px,92vw); margin:22px auto 40px}
    .top{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      padding:14px 16px;
      border:1px solid var(--stroke);
      border-radius:18px;
      background:rgba(12,18,24,.55);
      backdrop-filter: blur(8px);
    }
    .brand{display:flex; align-items:center; gap:10px; font-weight:900}
    .dot{width:10px;height:10px;border-radius:999px;background:var(--good);box-shadow:0 0 18px rgba(54,211,122,.35)}
    .badge{
      font-size:12px; font-weight:800; letter-spacing:.4px;
      padding:7px 12px; border-radius:999px;
      border:1px solid rgba(87,166,255,.35);
      background:rgba(10,18,26,.55);
      color:var(--blue);
    }
    .panel{
      margin-top:14px;
      padding:16px 16px;
      border:1px solid var(--stroke);
      border-radius:18px;
      background:var(--panel);
      backdrop-filter: blur(8px);
    }
    h1{margin:0 0 6px; font-size:18px}
    .sub{margin:0; color:var(--muted); font-size:12px}
    .row{display:flex; gap:10px; flex-wrap:wrap; margin-top:12px}
    .btn{
      display:inline-flex; align-items:center; justify-content:center;
      padding:10px 14px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(10,16,22,.35);
      color:var(--text);
      font-weight:800;
      text-decoration:none;
      cursor:pointer;
      user-select:none;
    }
    .btn.solid{
      background:linear-gradient(180deg,var(--blue),var(--blue2));
      border-color:rgba(87,166,255,.35);
      color:#071019;
      box-shadow:0 10px 24px rgba(87,166,255,.14);
    }
    .btn:hover{filter:brightness(1.03)}
    .inp{
      flex:1;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(8,12,16,.55);
      color:var(--text);
      outline:none;
      min-width:240px;
    }
    .inp:focus{border-color:rgba(87,166,255,.35)}
    .meta{
      margin-top:10px;
      display:flex; flex-wrap:wrap; gap:10px;
      color:var(--muted); font-size:12px;
    }
    .pill{
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.04);
    }
    table{width:100%; border-collapse:separate; border-spacing:0 10px; margin-top:10px}
    th{
      text-align:left; font-size:12px; color:var(--muted);
      font-weight:800; padding:0 10px;
    }
    td{
      padding:12px 10px;
      background:rgba(7,10,13,.45);
      border-top:1px solid rgba(255,255,255,.08);
      border-bottom:1px solid rgba(255,255,255,.08);
      font-size:12px;
      vertical-align:top;
    }
    tr td:first-child{
      border-left:1px solid rgba(255,255,255,.08);
      border-top-left-radius:14px;
      border-bottom-left-radius:14px;
    }
    tr td:last-child{
      border-right:1px solid rgba(255,255,255,.08);
      border-top-right-radius:14px;
      border-bottom-right-radius:14px;
    }
    .link{color:var(--blue); text-decoration:none; font-weight:800}
    .link:hover{text-decoration:underline}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}
    .small{font-size:11px; color:var(--muted)}
    .status{
      display:inline-flex; align-items:center; gap:6px;
      font-weight:900;
      padding:5px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.04);
    }
    .ok{color:#c8ffe0; border-color:rgba(54,211,122,.35); background:rgba(54,211,122,.10)}
    .nf{color:#e7edf6}
    .err{color:#ffd2d2; border-color:rgba(255,90,90,.30); background:rgba(255,90,90,.10)}
    .note{margin-top:10px; color:var(--muted); font-size:12px}
    @media (max-width:820px){
      th{display:none}
      table{border-spacing:0 12px}
      td{display:block}
      tr td:first-child, tr td:last-child{border-radius:14px}
    }
  </style>
</head>
<body>
  <div class="bg"></div>
  <main class="wrap">
    <header class="top">
      <div class="brand">
        <span class="dot" aria-hidden="true"></span>
        <span>EV424</span>
      </div>
      <div class="badge" title="Index view (not a verdict)">EVIDENCE INDEX</div>
    </header>

    <section class="panel">
      <h1>Public Evidence Index</h1>
      <p class="sub">Data source: <span class="mono">/public_data/toc.json</span> → monthly index → <span class="mono">/public_data/entries/</span></p>

      <div class="row">
        <input id="q" class="inp" placeholder="Filter by id / sha256 / title / filename" autocomplete="off" spellcheck="false" />
        <button id="reloadBtn" class="btn solid" type="button">Reload</button>
        <a class="btn" href="../index.html">Back</a>
      </div>

      <div class="meta">
        <div class="pill">generated_at: <span id="genAt" class="mono">-</span></div>
        <div class="pill">months: <span id="monthsN" class="mono">-</span></div>
        <div class="pill">evidence_count: <span id="evN" class="mono">-</span></div>
        <div class="pill">status: <span id="status" class="status nf">LOADING</span></div>
      </div>

      <div class="note">Tip: This page is static. To add evidence, you update <span class="mono">toc.json</span> / monthly index and redeploy. Note (EV424-specific): for entries <div class="note">Tip: This page is static. To add evidence, you update <span class="mono">toc.json</span> / monthly index and redeploy.</div>gt;=000006, "Open" may render the EV424 Passport/Final Receipt view. EV424 references publicly available documents only and is not affiliated with, endorsed by, or sponsored by any issuing organization or listed entity. To request correction/removal, contact <span class="mono">ev424.verify@gmail.com</span>.</div>
    </section>

    <section class="panel">
      <table>
        <thead>
          <tr>
            <th style="width:120px;">MONTH</th>
            <th>ITEM</th>
            <th style="width:120px;">SHA256</th>
            <th style="width:120px;">OPEN</th>
          </tr>
        </thead>
        <tbody id="rows"></tbody>
      </table>
      <div id="empty" class="note" hidden>No items matched.</div>
    </section>
  </main>

  <script>
  (() => {
    const TOC_URL = "/public_data/toc.json";

    const qEl = document.getElementById("q");
    const reloadBtn = document.getElementById("reloadBtn");
    const rowsEl = document.getElementById("rows");
    const emptyEl = document.getElementById("empty");

    const genAtEl = document.getElementById("genAt");
    const monthsNEl = document.getElementById("monthsN");
    const evNEl = document.getElementById("evN");
    const statusEl = document.getElementById("status");

    function setStatus(kind, text){
      statusEl.className = "status " + (kind || "nf");
      statusEl.textContent = text || "";
    }

    async function loadJSON(url){
      const r = await fetch(url, { cache: "no-store" });
      if(!r.ok) throw new Error(`${url} fetch failed: ${r.status} ${r.statusText}`);
      return await r.json();
    }

    function escapeHtml(s){
      return String(s ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function shortSha(s){
      const x = String(s || "");
      if(x.length <= 14) return x;
      return x.slice(0,8) + "…" + x.slice(-6);
    }

    function normalize(s){ return String(s ?? "").trim().toLowerCase(); }

    function toFlatItems(toc, monthIdxMap){
      // Expect:
      // toc.months: [{ month, href, sha256, sha256_file, counts:{EVIDENCE...}}]
      // month index file: expected to contain items (either "items" or "entries")
      const out = [];
      for(const m of (toc?.months || [])){
        const month = m?.month || "";
        const href = m?.href || "";
        const idx = monthIdxMap.get(href);
        const items = Array.isArray(idx?.items) ? idx.items : Array.isArray(idx?.entries) ? idx.entries : [];
        for(const it of items){
          const id = it?.entry_id ?? it?.id ?? it?.evidence_id ?? it?.eid ?? "";
          const sha256 = it?.sha256 ?? "";
          const title = it?.title ?? it?.name ?? it?.subject ?? "";
          const file = it?.file ?? it?.path ?? it?.href ?? it?.url ?? "";
          // file is expected relative to public_data root in your build (e.g., "entries/xxx.pdf")
          const openUrl = file ? (file.startsWith("http") ? file : ("/public_data/" + file.replace(/^\/+/,""))) : "";
          out.push({ month, id, sha256, title, file, openUrl });
        }
      }
      return out;
    }

    function render(items){
      rowsEl.innerHTML = "";
      const q = normalize(qEl.value);
      let filtered = !q ? items : items.filter(it => {
        const blob = normalize([it.month,it.id,it.sha256,it.title,it.file].join(" | "));
        return blob.includes(q);
      });

        // order: entry_id ascending (EV424-ENTRY-000001 -> ...)
        filtered = filtered.slice().sort((a,b) => String(a.id||"").localeCompare(String(b.id||""), undefined, { numeric:true }));

      emptyEl.hidden = filtered.length !== 0;

      for(const it of filtered){
        const month = escapeHtml(it.month);
        const id = escapeHtml(it.id || "-");
        const title = escapeHtml(it.title || "");
        const file = escapeHtml(it.file || "-");
        const shaShort = escapeHtml(shortSha(it.sha256 || "-"));
        const shaFull = escapeHtml(it.sha256 || "-");
        const openUrl = it.openUrl || "";

        const openCell = openUrl
          ? `<a class="link" href="${escapeHtml(openUrl)}" target="_blank" rel="noopener">Open</a>`
          : `<span class="small">No file</span>`;

        rowsEl.insertAdjacentHTML("beforeend", `
          <tr>
            <td class="mono">${month || "-"}</td>
            <td>
              <div><span class="mono">${id}</span></div>
              ${title ? `<div class="small">${title}</div>` : ""}
              <div class="small mono">${file}</div>
            </td>
            <td class="mono" title="${shaFull}">${shaShort}</td>
            <td>${openCell}</td>
          </tr>
        `);
      }
    }

    async function main(){
      try{
        setStatus("nf","LOADING");
        const toc = await loadJSON(TOC_URL);

        genAtEl.textContent = toc?.generated_at || "-";
        monthsNEl.textContent = String((toc?.months || []).length);

        // load all month indexes
        const monthIdxMap = new Map();
        let evCount = 0;

        for(const m of (toc?.months || [])){
          const href = m?.href || "";
          if(!href) continue;
          const idx = await loadJSON("/public_data/" + href.replace(/^\/+/,""));
          monthIdxMap.set(href, idx);

          // count evidence-like entries
          const items = Array.isArray(idx?.items) ? idx.items : Array.isArray(idx?.entries) ? idx.entries : [];
          evCount += items.length;
        }

        evNEl.textContent = String(evCount);

        const flat = toFlatItems(toc, monthIdxMap);
        setStatus("ok","READY");
        render(flat);

        qEl.addEventListener("input", () => render(flat));
        reloadBtn.addEventListener("click", () => main());
      } catch(e){
        setStatus("err","ERROR");
        rowsEl.innerHTML = "";
        emptyEl.hidden = false;
        emptyEl.textContent = "Failed to load toc/index: " + String(e && e.message ? e.message : e);
      }
    }

    main();
  })();
  </script>
</body>
</html>
